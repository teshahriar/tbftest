{% extends "admin_base.html" %}

{% block content %}
<style>
    .admin-container { padding: 30px; background: #f8fafc; min-height: 100vh; font-family: 'Segoe UI', sans-serif; }
    
    /* Header & Quick Buttons */
    .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; gap: 15px; flex-wrap: wrap; }
    .grade-tabs { display: flex; gap: 8px; background: #e2e8f0; padding: 5px; border-radius: 10px; }
    .tab-link { 
        padding: 8px 16px; border-radius: 7px; text-decoration: none; 
        font-size: 13px; font-weight: 700; color: #475569; transition: 0.3s;
    }
    .tab-link.active { background: white; color: #1e293b; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

    /* Result Publish Button Styling */
    .publish-section { display: flex; align-items: center; gap: 10px; }
    .btn-publish {
        padding: 10px 20px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer;
        display: flex; align-items: center; gap: 8px; transition: 0.3s; font-size: 14px;
    }
    .btn-status-on { background: #10b981; color: white; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); }
    .btn-status-off { background: #64748b; color: white; }
    .btn-publish:hover { opacity: 0.9; transform: translateY(-2px); }

    /* Filter Panel */
    .filter-card { 
        background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;
        display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;
    }
    .filter-item label { display: block; font-size: 11px; font-weight: 800; color: #94a3b8; margin-bottom: 5px; }
    .filter-item select { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #cbd5e0; }

    /* Table & Stats */
    .res-table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px 12px 0 0; overflow: hidden; border: 1px solid #e2e8f0; }
    .res-table th { background: #f1f5f9; padding: 12px; text-align: left; font-size: 12px; color: #64748b; text-transform: uppercase; }
    .res-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }

    .summary-footer { 
        background: #1e293b; color: white; padding: 20px; border-radius: 0 0 12px 12px;
        display: flex; justify-content: space-around; text-align: center;
    }
    .stat-label { font-size: 11px; opacity: 0.7; text-transform: uppercase; display: block; }
    .stat-value { font-size: 20px; font-weight: 800; color: #10b981; }

    .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
</style>

<div class="admin-container">
    <div class="header-flex">
        <h2 style="margin:0; color: #1e293b;">Results Registry</h2>
        
        <div class="publish-section">
            <form action="{{ url_for('toggle_result_publish') }}" method="POST">
                {% if is_published %}
                    <button type="submit" class="btn-publish btn-status-on">
                        Result Published
                    </button>
                {% else %}
                    <button type="submit" class="btn-publish btn-status-off">
                        Publish Result
                    </button>
                {% endif %}
            </form>

            <div class="grade-tabs">
                <a href="{{ url_for('manage_results') }}" class="tab-link {{ 'active' if not request.args.get('grade') }}">All</a>
                <a href="{{ url_for('manage_results', grade='Talentpool') }}" class="tab-link {{ 'active' if request.args.get('grade') == 'Talentpool' }}">Talentpool</a>
                <a href="{{ url_for('manage_results', grade='General') }}" class="tab-link {{ 'active' if request.args.get('grade') == 'General' }}">General</a>
                <a href="{{ url_for('manage_results', grade='Suveccha') }}" class="tab-link {{ 'active' if request.args.get('grade') == 'Suveccha' }}">Suveccha</a>
                <a href="{{ url_for('manage_results', grade='Nothing') }}" class="tab-link {{ 'active' if request.args.get('grade') == 'Nothing' }}">Nothing</a>
                <a href="{{ url_for('manage_results', grade='Quata') }}" class="tab-link {{ 'active' if request.args.get('grade') == 'Quata' }}">Quata</a>
            </div>
        </div>
    </div>

    <form method="GET" class="filter-card">
        <input type="hidden" name="grade" value="{{ request.args.get('grade', '') }}">
        <div class="filter-item">
            <label>Sort By</label>
            <select name="sort">
                <option value="merit" {% if request.args.get('sort') == 'merit' %}selected{% endif %}>Merit List</option>
                <option value="roll" {% if request.args.get('sort') == 'roll' %}selected{% endif %}>Roll No</option>
                <option value="name" {% if request.args.get('sort') == 'name' %}selected{% endif %}>Name</option>
            </select>
        </div>
        <div class="filter-item">
            <label>Class</label>
            <select name="class">
                <option value="">All Classes</option>
                {% for c in ["5","6","7","8","9"] %}<option value="{{c}}" {% if request.args.get('class') == c %}selected{% endif %}>Class {{c}}</option>{% endfor %}
            </select>
        </div>
        <div class="filter-item">
            <label>Exam Center</label>
            <select name="center">
                <option value="">All Centers</option>
                {% for c in centers %}<option value="{{c}}" {% if request.args.get('center') == c %}selected{% endif %}>{{c}}</option>{% endfor %}
            </select>
        </div>
        <button type="submit" style="background:#1e293b; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:700;">Apply Filters</button>
    </form>

    <table class="res-table">
        <thead>
            <tr>
                <th>Rank</th>
                <th>Student</th>
                <th>Institute</th>
                <th style="text-align:center;">Total</th>
                <th>Grade</th>
                <th>Manage</th>
            </tr>
        </thead>
        <tbody>
            {% for s in results %}
            {% set marks = s.get('marks') or {} %}
            <tr>
                <td style="font-weight:800; color:#94a3b8;">#{{ loop.index }}</td>
                <td>
                    <div style="font-weight:700;">{{ s.name_en }}</div>
                    <div style="font-size:11px; color:#64748b;">Roll: {{ s.roll_no }} | Class: {{ s.student_class }}</div>
                </td>
                <td style="font-size:12px;">{{ s.institute_en }}</td>
                <td style="text-align:center; font-weight:800; color:#10b981;">{{ marks.get('total', 0) }}</td>
                <td>
                    {% if s.scholarship_grade == 'Talentpool' %}
                        <span class="badge" style="background:#fef3c7; color:#92400e;">TALENTPOOL</span>
                    {% elif s.scholarship_grade == 'General' %}
                        <span class="badge" style="background:#d1fae5; color:#065f46;">GENERAL</span>
                    {% elif s.scholarship_grade == 'Suveccha' %}
                        <span class="badge" style="background:#e0f2fe; color:#0369a1;">SUVECCHA</span>
                    {% else %}
                        <span class="badge" style="background:#f1f5f9; color:#475569;">NOTHING</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('entry_marks') }}?roll_no={{ s.roll_no }}" style="color:#3b82f6; text-decoration:none; font-weight:bold;">Edit</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="summary-footer">
        <div><span class="stat-label">Total Students</span><span class="stat-value">{{ total_count }}</span></div>
        <div><span class="stat-label">Sum of Marks</span><span class="stat-value">{{ sum_marks }}</span></div>
        <div><span class="stat-label">Average Score</span><span class="stat-value">{{ avg_score|round(2) }}</span></div>
    </div>
</div>
{% endblock %}