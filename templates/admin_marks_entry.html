<<<<<<< HEAD
{% extends "admin_base.html" %}
{% block content %}
<style>
    :root {
        --primary: #4f46e5;
        --secondary: #64748b;
        --success: #10b981;
        --danger: #ef4444;
        --bg-body: #f1f5f9;
        --card-bg: #ffffff;
        --border: #e2e8f0;
    }

    .bulk-wrapper {
        padding: 2rem;
        animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Header Styling */
    .page-header { margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center; }
    .page-header h2 { font-size: 1.875rem; color: #1e293b; font-weight: 800; margin: 0; }
    
    /* Control Panel (Filters) */
    .control-panel {
        background: var(--card-bg);
        padding: 1.5rem;
        border-radius: 1rem;
        border: 1px solid var(--border);
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        margin-bottom: 2rem;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.25rem;
        align-items: flex-end;
    }

    .input-box label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--secondary);
        margin-bottom: 0.5rem;
    }

    .custom-select {
        width: 100%;
        padding: 0.625rem;
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        font-size: 0.95rem;
        background: white;
        transition: all 0.2s;
    }

    .custom-select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

    /* Modern Table Styling */
    .table-container {
        background: var(--card-bg);
        border-radius: 1rem;
        border: 1px solid var(--border);
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        overflow-x: auto;
    }

    .modern-table { width: 100%; border-collapse: collapse; text-align: left; min-width: 900px; }
    
    .modern-table thead tr { background: #f8fafc; border-bottom: 2px solid var(--border); }

    .modern-table th {
        padding: 1rem;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--secondary);
    }

    .modern-table tbody tr { border-bottom: 1px solid var(--border); transition: background 0.2s; }
    .modern-table tbody tr:hover { background: #f8fafc; }

    .roll-pill {
        background: #e0e7ff; color: #4338ca;
        padding: 4px 10px; border-radius: 6px; font-weight: 700; font-size: 0.85rem;
    }

    /* Marks Inputs */
    .mark-field {
        width: 70px;
        padding: 0.6rem;
        text-align: center;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-weight: 700;
        color: #1e293b;
        transition: all 0.2s;
    }
    .mark-field:focus { 
        border-color: var(--primary); 
        outline: none; 
        background: #fdf2f2; /* Light tint to show active row */
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    /* Remove arrows from number input */
    .mark-field::-webkit-inner-spin-button, 
    .mark-field::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

    .row-total { font-weight: 800; color: var(--secondary); font-size: 1.1rem; }

    /* Action Bar */
    .action-bar {
        position: sticky;
        bottom: 2rem;
        margin-top: 2rem;
        display: flex;
        justify-content: flex-end;
    }

    .btn-save-all {
        background: var(--success);
        color: white;
        padding: 1rem 3rem;
        border-radius: 0.75rem;
        font-weight: 700;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.4);
        transition: all 0.2s;
    }

    .btn-save-all:hover { transform: translateY(-2px); filter: brightness(1.05); }
</style>

<div class="bulk-wrapper">
    <div class="page-header">
        <div>
            <h2>Bulk Marks Allocation</h2>
            <p style="color: var(--secondary); margin-top: 5px;">Class-wise batch marks entry portal.</p>
        </div>
        <div id="status-indicator" style="font-size: 0.8rem; font-weight: 600; color: var(--secondary);">
            <i class="fas fa-circle" style="color: var(--success); font-size: 0.6rem;"></i> System Ready
        </div>
    </div>

    <div class="control-panel">
        <form method="GET" class="filter-grid">
            <div class="input-box">
                <label>Target Class</label>
                <select name="class" class="custom-select" required>
                    <option value="">Choose Class...</option>
                    {% for c in ["5","6","7","8","9"] %}
                    <option value="{{c}}" {{ 'selected' if request.args.get('class') == c }}>Grade {{c}}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="input-box">
                <label>Institution</label>
                <select name="institute" class="custom-select">
                    <option value="">All Institutions</option>
                    {% for inst in institutes %}
                    <option value="{{inst.name}}" {{ 'selected' if request.args.get('institute') == inst.name }}>{{inst.name}}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn-save-all" style="background: #1e293b; box-shadow: none; padding: 0.7rem 1.5rem; height: 45px;">
                <i class="fas fa-search"></i> Fetch Students
            </button>
        </form>
    </div>

    {% if students %}
    
    <form action="{{ url_for('save_bulk_marks') }}" method="POST">
        <div class="table-container">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th style="width: 100px; text-align: center;">Roll</th>
                        <th>Student Identity</th>
                        <th style="text-align: center;">Bangla (25)</th>
                        <th style="text-align: center;">English (25)</th>
                        <th style="text-align: center;">Math (25)</th>
                        <th style="text-align: center;">G.K (25)</th>
                        <th style="text-align: center;">Total</th>
                        <th style="width: 150px;">Scholarship</th>
                    </tr>
                </thead>
                <tbody id="bulkTableBody">
                    {% for s in students %}
                    <tr>
                        <td style="text-align: center;"><span class="roll-pill">{{ s.roll_no }}</span></td>
                        <td>
                            <div style="font-weight: 700; color: #1e293b; font-size: 0.95rem;">{{ s.name_en }}</div>
                            <div style="font-size: 0.75rem; color: var(--secondary);">{{ s.institute_en }}</div>
                            <input type="hidden" name="roll_no[]" value="{{ s.roll_no }}">
                        </td>
                        <td style="text-align: center;">
                            <input type="number" name="ban[]" step="0.5" max="25" class="mark-field m-input" 
                            value="{{ s.marks.bangla if (s.marks and s.marks.bangla is not none and s.marks.bangla != 0) else '' }}" placeholder="-">
                        </td>
                        <td style="text-align: center;">
                            <input type="number" name="eng[]" step="0.5" max="25" class="mark-field m-input" 
                            value="{{ s.marks.english if (s.marks and s.marks.english is not none and s.marks.english != 0) else '' }}" placeholder="-">
                        </td>
                        <td style="text-align: center;">
                            <input type="number" name="math[]" step="0.5" max="25" class="mark-field m-input" 
                            value="{{ s.marks.math if (s.marks and s.marks.math is not none and s.marks.math != 0) else '' }}" placeholder="-">
                        </td>
                        <td style="text-align: center;">
                            <input type="number" name="gk[]" step="0.5" max="25" class="mark-field m-input" 
                            value="{{ s.marks.gk if (s.marks and s.marks.gk is not none and s.marks.gk != 0) else '' }}" placeholder="-">
                        </td>
                        <td style="text-align: center;"><span class="row-total">0.00</span></td>
                        <td>
                            <select name="scholarship_grade[]" class="custom-select" style="font-size: 0.8rem; font-weight: bold; border-color: #cbd5e1;">
                                <option value="Nothing" {{ 'selected' if s.scholarship_grade == 'Nothing' }}>Nothing</option>
                                <option value="Talentpool" {{ 'selected' if s.scholarship_grade == 'Talentpool' }}>Talentpool</option>
                                <option value="General" {{ 'selected' if s.scholarship_grade == 'General' }}>General</option>
                                <option value="Suveccha" {{ 'selected' if s.scholarship_grade == 'Suveccha' }}>Suveccha</option>
                                <option value="Quata" {{ 'selected' if s.scholarship_grade == 'Quata' }}>Quata</option>
                            </select>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="action-bar">
            <button type="submit" class="btn-save-all" onclick="return confirm('Are you sure you want to save all changes?')">
                <i class="fas fa-check-double"></i> Finalize & Save All
            </button>
        </div>
    </form>
    {% else %}
    <div style="text-align: center; padding: 4rem; background: white; border-radius: 1rem; border: 2px dashed var(--border);">
        <i class="fas fa-user-clock" style="font-size: 3rem; color: var(--border); margin-bottom: 1rem;"></i>
        <h3 style="color: var(--secondary);">No students found.</h3>
        <p style="color: #94a3b8;">Please select a class and institution to load the grading sheet.</p>
    </div>
    {% endif %}
</div>

<script>
    function calculate() {
        const rows = document.querySelectorAll('#bulkTableBody tr');
        rows.forEach(row => {
            const inputs = row.querySelectorAll('.m-input');
            let total = 0;
            inputs.forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            const totalEl = row.querySelector('.row-total');
            totalEl.innerText = total.toFixed(2);
            
            // Dynamic color coding
            if(total > 0) {
                if(total >= 80) totalEl.style.color = '#10b981'; // Green
                else if(total >= 40) totalEl.style.color = '#4f46e5'; // Blue
                else totalEl.style.color = '#f59e0b'; // Amber
            } else {
                totalEl.style.color = '#64748b'; // Default Grey
            }
        });
    }

    // Event listeners for live calculation
    document.querySelectorAll('.m-input').forEach(input => {
        input.addEventListener('input', calculate);
    });

    // Run calculation once on page load to show existing totals
    window.onload = calculate;
</script>
=======
{% extends "admin_base.html" %}
{% block content %}
<style>
    :root {
        --primary: #4f46e5;
        --secondary: #64748b;
        --success: #10b981;
        --danger: #ef4444;
        --bg-body: #f1f5f9;
        --card-bg: #ffffff;
        --border: #e2e8f0;
    }

    .bulk-wrapper {
        padding: 2rem;
        animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Header Styling */
    .page-header { margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center; }
    .page-header h2 { font-size: 1.875rem; color: #1e293b; font-weight: 800; margin: 0; }
    
    /* Control Panel (Filters) */
    .control-panel {
        background: var(--card-bg);
        padding: 1.5rem;
        border-radius: 1rem;
        border: 1px solid var(--border);
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        margin-bottom: 2rem;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.25rem;
        align-items: flex-end;
    }

    .input-box label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--secondary);
        margin-bottom: 0.5rem;
    }

    .custom-select {
        width: 100%;
        padding: 0.625rem;
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        font-size: 0.95rem;
        background: white;
        transition: all 0.2s;
    }

    .custom-select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

    /* Modern Table Styling */
    .table-container {
        background: var(--card-bg);
        border-radius: 1rem;
        border: 1px solid var(--border);
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        overflow-x: auto;
    }

    .modern-table { width: 100%; border-collapse: collapse; text-align: left; min-width: 900px; }
    
    .modern-table thead tr { background: #f8fafc; border-bottom: 2px solid var(--border); }

    .modern-table th {
        padding: 1rem;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--secondary);
    }

    .modern-table tbody tr { border-bottom: 1px solid var(--border); transition: background 0.2s; }
    .modern-table tbody tr:hover { background: #f8fafc; }

    .roll-pill {
        background: #e0e7ff; color: #4338ca;
        padding: 4px 10px; border-radius: 6px; font-weight: 700; font-size: 0.85rem;
    }

    /* Marks Inputs */
    .mark-field {
        width: 70px;
        padding: 0.6rem;
        text-align: center;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-weight: 700;
        color: #1e293b;
        transition: all 0.2s;
    }
    .mark-field:focus { 
        border-color: var(--primary); 
        outline: none; 
        background: #fdf2f2; /* Light tint to show active row */
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    /* Remove arrows from number input */
    .mark-field::-webkit-inner-spin-button, 
    .mark-field::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

    .row-total { font-weight: 800; color: var(--secondary); font-size: 1.1rem; }

    /* Action Bar */
    .action-bar {
        position: sticky;
        bottom: 2rem;
        margin-top: 2rem;
        display: flex;
        justify-content: flex-end;
    }

    .btn-save-all {
        background: var(--success);
        color: white;
        padding: 1rem 3rem;
        border-radius: 0.75rem;
        font-weight: 700;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.4);
        transition: all 0.2s;
    }

    .btn-save-all:hover { transform: translateY(-2px); filter: brightness(1.05); }
</style>

<div class="bulk-wrapper">
    <div class="page-header">
        <div>
            <h2>Bulk Marks Allocation</h2>
            <p style="color: var(--secondary); margin-top: 5px;">Class-wise batch marks entry portal.</p>
        </div>
        <div id="status-indicator" style="font-size: 0.8rem; font-weight: 600; color: var(--secondary);">
            <i class="fas fa-circle" style="color: var(--success); font-size: 0.6rem;"></i> System Ready
        </div>
    </div>

    <div class="control-panel">
        <form method="GET" class="filter-grid">
            <div class="input-box">
                <label>Target Class</label>
                <select name="class" class="custom-select" required>
                    <option value="">Choose Class...</option>
                    {% for c in ["5","6","7","8","9"] %}
                    <option value="{{c}}" {{ 'selected' if request.args.get('class') == c }}>Grade {{c}}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="input-box">
                <label>Institution</label>
                <select name="institute" class="custom-select">
                    <option value="">All Institutions</option>
                    {% for inst in institutes %}
                    <option value="{{inst.name}}" {{ 'selected' if request.args.get('institute') == inst.name }}>{{inst.name}}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn-save-all" style="background: #1e293b; box-shadow: none; padding: 0.7rem 1.5rem; height: 45px;">
                <i class="fas fa-search"></i> Fetch Students
            </button>
        </form>
    </div>

    {% if students %}
    
    <form action="{{ url_for('save_bulk_marks') }}" method="POST">
        <div class="table-container">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th style="width: 100px; text-align: center;">Roll</th>
                        <th>Student Identity</th>
                        <th style="text-align: center;">Bangla (25)</th>
                        <th style="text-align: center;">English (25)</th>
                        <th style="text-align: center;">Math (25)</th>
                        <th style="text-align: center;">G.K (25)</th>
                        <th style="text-align: center;">Total</th>
                        <th style="width: 150px;">Scholarship</th>
                    </tr>
                </thead>
                <tbody id="bulkTableBody">
                    {% for s in students %}
                    <tr>
                        <td style="text-align: center;"><span class="roll-pill">{{ s.roll_no }}</span></td>
                        <td>
                            <div style="font-weight: 700; color: #1e293b; font-size: 0.95rem;">{{ s.name_en }}</div>
                            <div style="font-size: 0.75rem; color: var(--secondary);">{{ s.institute_en }}</div>
                            <input type="hidden" name="roll_no[]" value="{{ s.roll_no }}">
                        </td>
                        <td style="text-align: center;">
                            <input type="number" name="ban[]" step="0.5" max="25" class="mark-field m-input" 
                            value="{{ s.marks.bangla if (s.marks and s.marks.bangla is not none and s.marks.bangla != 0) else '' }}" placeholder="-">
                        </td>
                        <td style="text-align: center;">
                            <input type="number" name="eng[]" step="0.5" max="25" class="mark-field m-input" 
                            value="{{ s.marks.english if (s.marks and s.marks.english is not none and s.marks.english != 0) else '' }}" placeholder="-">
                        </td>
                        <td style="text-align: center;">
                            <input type="number" name="math[]" step="0.5" max="25" class="mark-field m-input" 
                            value="{{ s.marks.math if (s.marks and s.marks.math is not none and s.marks.math != 0) else '' }}" placeholder="-">
                        </td>
                        <td style="text-align: center;">
                            <input type="number" name="gk[]" step="0.5" max="25" class="mark-field m-input" 
                            value="{{ s.marks.gk if (s.marks and s.marks.gk is not none and s.marks.gk != 0) else '' }}" placeholder="-">
                        </td>
                        <td style="text-align: center;"><span class="row-total">0.00</span></td>
                        <td>
                            <select name="scholarship_grade[]" class="custom-select" style="font-size: 0.8rem; font-weight: bold; border-color: #cbd5e1;">
                                <option value="Nothing" {{ 'selected' if s.scholarship_grade == 'Nothing' }}>Nothing</option>
                                <option value="Talentpool" {{ 'selected' if s.scholarship_grade == 'Talentpool' }}>Talentpool</option>
                                <option value="General" {{ 'selected' if s.scholarship_grade == 'General' }}>General</option>
                                <option value="Suveccha" {{ 'selected' if s.scholarship_grade == 'Suveccha' }}>Suveccha</option>
                                <option value="Quata" {{ 'selected' if s.scholarship_grade == 'Quata' }}>Quata</option>
                            </select>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="action-bar">
            <button type="submit" class="btn-save-all" onclick="return confirm('Are you sure you want to save all changes?')">
                <i class="fas fa-check-double"></i> Finalize & Save All
            </button>
        </div>
    </form>
    {% else %}
    <div style="text-align: center; padding: 4rem; background: white; border-radius: 1rem; border: 2px dashed var(--border);">
        <i class="fas fa-user-clock" style="font-size: 3rem; color: var(--border); margin-bottom: 1rem;"></i>
        <h3 style="color: var(--secondary);">No students found.</h3>
        <p style="color: #94a3b8;">Please select a class and institution to load the grading sheet.</p>
    </div>
    {% endif %}
</div>

<script>
    function calculate() {
        const rows = document.querySelectorAll('#bulkTableBody tr');
        rows.forEach(row => {
            const inputs = row.querySelectorAll('.m-input');
            let total = 0;
            inputs.forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            const totalEl = row.querySelector('.row-total');
            totalEl.innerText = total.toFixed(2);
            
            // Dynamic color coding
            if(total > 0) {
                if(total >= 80) totalEl.style.color = '#10b981'; // Green
                else if(total >= 40) totalEl.style.color = '#4f46e5'; // Blue
                else totalEl.style.color = '#f59e0b'; // Amber
            } else {
                totalEl.style.color = '#64748b'; // Default Grey
            }
        });
    }

    // Event listeners for live calculation
    document.querySelectorAll('.m-input').forEach(input => {
        input.addEventListener('input', calculate);
    });

    // Run calculation once on page load to show existing totals
    window.onload = calculate;
</script>
>>>>>>> 6543cec (new 1)
{% endblock %}